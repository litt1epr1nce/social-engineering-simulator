"""Seed 12 scenarios on first run. Realistic, neutral language. User-facing text in Russian."""
import json

from sqlalchemy import func, select
from sqlalchemy.ext.asyncio import AsyncSession

from app.models.scenario import Scenario


def _choices(*items: tuple[str, bool, str, int]) -> str:
    """Build choices JSON from (text, is_safe, explanation, score_delta)."""
    return json.dumps([
        {"text": t, "is_safe": s, "explanation": e, "score_delta": d}
        for t, s, e, d in items
    ])


SCENARIOS = [
    {
        "title": "Срочный сброс пароля",
        "channel": "email",
        "message_text": "Ваш аккаунт будет заблокирован через 2 часа. Нажмите здесь, чтобы сбросить пароль: [ссылка]. Мы никогда не запрашиваем пароль по email.",
        "tactic": "Urgency",
        "choices_json": _choices(
            ("Перейти по ссылке и сбросить пароль", False, "Срочность: короткий срок заставляет действовать не проверяя. Настоящие сервисы так не блокируют.", 10),
            ("Открыть сайт компании в браузере и зайти в настройки аккаунта", True, "Верно. Официальный сайт защищает от поддельных ссылок.", -5),
            ("Ответить на письмо с просьбой продлить срок", False, "Ответ подтвердит, что почта активна, и может привести к новым атакам.", 10),
            ("Игнорировать и проверить аккаунт через официальное приложение", True, "Верно. Официальное приложение безопаснее ссылок из письма.", -5),
        ),
    },
    {
        "title": "Запрос от IT-поддержки",
        "channel": "messenger",
        "message_text": "Здравствуйте, это техподдержка. Проводим обновление безопасности. Выполните в терминале команду и пришлите вывод: ipconfig /all",
        "tactic": "Authority",
        "choices_json": _choices(
            ("Выполнить команду и отправить вывод", False, "Авторитет: под видом IT могут выманить данные сети. Всегда проверяйте через официальный канал.", 10),
            ("Попросить номер заявки и проверить через корпоративный портал", True, "Верно. Проверка через официальные каналы защищает от подделок.", -5),
            ("Игнорировать сообщение", True, "Безопасно. Игнорировать непроверенные запросы — нормальная практика.", -5),
            ("Переслать руководителю для подтверждения", True, "Верно. Эскалация известному лицу — правильная проверка.", -5),
        ),
    },
    {
        "title": "Ограниченное предложение",
        "channel": "email",
        "message_text": "Осталось 5 мест со скидкой 80% на курс. Забронируйте скидку в течение 24 часов: [ссылка]. Карта не нужна для брони.",
        "tactic": "Scarcity",
        "choices_json": _choices(
            ("Нажать, чтобы забронировать место", False, "Дефицит: «осталось 5» и срок подталкивают к действию. Часто так собирают контакты или продают сомнительное.", 10),
            ("Поискать отзывы о курсе и компании", True, "Верно. Проверка репутации снижает риск обмана.", -5),
            ("Игнорировать письмо", True, "Безопасно. Игнорировать навязчивый маркетинг нормально.", -5),
            ("Переслать знакомому", False, "Пересылка ссылки подвергает других тем же рискам.", 10),
        ),
    },
    {
        "title": "Бесплатная проверка безопасности",
        "channel": "call",
        "message_text": "Здравствуйте, предлагаем бесплатный аудит безопасности вашего компьютера. Мы помогли тысячам пользователей. Можем подключиться удалённо на 10 минут для проверки?",
        "tactic": "Reciprocity",
        "choices_json": _choices(
            ("Согласиться и разрешить удалённый доступ", False, "Взаимность: «бесплатно» создаёт ощущение долга. Удалённый доступ может отдать управление мошенникам.", 10),
            ("Отказаться и положить трубку", True, "Верно. Неожиданные предложения удалённого доступа — частый сценарий обмана.", -5),
            ("Попросить название компании и перезвонить по номеру с их сайта", True, "Верно. Перезвон по проверенному номеру защищает от подделок.", -5),
            ("Сказать, что подумаете, и поискать компанию", True, "Верно. Время на проверку — безопасный подход.", -5),
        ),
    },
    {
        "title": "Подозрительная активность",
        "channel": "email",
        "message_text": "Обнаружены подозрительные входы в ваш аккаунт. Защитите его, перейдя по ссылке: [ссылка]. Если не действовать в течение часа, аккаунт может быть заблокирован.",
        "tactic": "Fear",
        "choices_json": _choices(
            ("Перейти по ссылке и войти для защиты", False, "Страх: угроза блокировки подталкивает перейти по ссылке. Ссылка может вести на поддельную страницу.", 10),
            ("Открыть официальный сайт или приложение и проверить активность там", True, "Верно. Официальное приложение или сайт защищают от фишинга.", -5),
            ("Ответить на письмо и оставить телефон для звонка", False, "Передача контактов непроверенному отправителю рискованна.", 10),
            ("Игнорировать и зайти в сервис через сохранённую закладку", True, "Верно. Закладка — безопасный способ зайти.", -5),
        ),
    },
    {
        "title": "Обновление политики HR",
        "channel": "messenger",
        "message_text": "Здравствуйте, отдел кадров. Обновляем данные для зарплаты. Подтвердите номер счёта и банка в форме по ссылке: [ссылка]. Нужно до 17:00 сегодня.",
        "tactic": "Authority",
        "choices_json": _choices(
            ("Заполнить форму до дедлайна", False, "Авторитет и срочность: настоящий HR не рассылает ссылки с дедлайном в один день.", 10),
            ("Проверить интранет на официальное объявление HR", True, "Верно. Проверка через официальные каналы безопасна.", -5),
            ("Позвонить в HR по номеру с сайта компании", True, "Верно. Перезвон по известному номеру защищает от подделок.", -5),
            ("Переслать сообщение руководителю", True, "Разумно. Эскалация защищает и уточняет процедуру.", -5),
        ),
    },
    {
        "title": "Последний шанс на скидку",
        "channel": "email",
        "message_text": "Ваша персональная скидка истекает сегодня. Мы зарезервировали её для вас. Нажмите, чтобы получить до полуночи: [ссылка].",
        "tactic": "Scarcity",
        "choices_json": _choices(
            ("Нажать, чтобы получить до истечения", False, "Дефицит: «истекает сегодня» и «только для вас» подталкивают к быстрому действию. Часто используется в фишинге.", 10),
            ("Зайти на официальный сайт бренда и посмотреть акции", True, "Верно. Официальный сайт защищает от поддельных ссылок.", -5),
            ("Отписаться от рассылки", True, "Безопасно. Меньше рассылок — меньше рисков.", -5),
            ("Ответить с просьбой продлить предложение", False, "Ответ подтвердит адрес и может привести к новым попыткам.", 10),
        ),
    },
    {
        "title": "Просьба коллеги",
        "channel": "messenger",
        "message_text": "Привет, я на встрече, не могу открыть общий диск. Открой файл по ссылке и напиши, что там: [ссылка]. Это с нашего проекта.",
        "tactic": "Reciprocity",
        "choices_json": _choices(
            ("Открыть ссылку и посмотреть файл", False, "Взаимность: помощь «коллеге» кажется естественной, но ссылка может быть вредоносной. Проверьте отправителя.", 10),
            ("Написать с просьбой подтвердить лично или в известном канале", True, "Верно. Проверка личности защищает от социальной инженерии.", -5),
            ("Игнорировать до сообщения с привычного аккаунта", True, "Безопасно. Взломанные или поддельные аккаунты встречаются часто.", -5),
            ("Переслать в IT для проверки ссылки", True, "Разумно. IT может проверить ссылку до перехода.", -5),
        ),
    },
    {
        "title": "Требуется верификация аккаунта",
        "channel": "email",
        "message_text": "Ваш аккаунт помечен для проверки. Чтобы избежать постоянной блокировки, подтвердите личность в течение 48 часов: [ссылка]. Это последнее уведомление.",
        "tactic": "Fear",
        "choices_json": _choices(
            ("Перейти по ссылке и пройти верификацию", False, "Страх: угроза блокировки подталкивает к действию. Ссылки из писем часто ведут на фишинговые страницы.", 10),
            ("Войти через официальное приложение или сохранённую закладку и проверить уведомления", True, "Верно. Официальное приложение или сайт безопасны.", -5),
            ("Найти контакты поддержки компании и написать им", True, "Верно. Обращение через официальные каналы безопасно.", -5),
            ("Ответить на письмо с вопросом", False, "Ответ подтвердит адрес; лучше использовать официальные каналы.", 10),
        ),
    },
    {
        "title": "Запрос от CEO",
        "channel": "messenger",
        "message_text": "Привет, нужна срочная конфиденциальная помощь. Можешь купить 10 подарочных карт и прислать коды? Я возмещу. Никому не говори — сюрприз.",
        "tactic": "Authority",
        "choices_json": _choices(
            ("Купить карты и отправить коды", False, "Авторитет: руководители не просят карты в мессенджере. Это типичный сценарий мошенничества.", 10),
            ("Проверить запрос по другому каналу (звонок, лично)", True, "Верно. Настоящего руководителя можно проверить через известные каналы.", -5),
            ("Отказать и сообщить в IT или безопасность", True, "Верно. Сообщение защищает вас и организацию.", -5),
            ("Попросить письменное подтверждение", True, "Разумно. Документ и проверка снижают риск.", -5),
        ),
    },
    {
        "title": "Эксклюзивный ранний доступ",
        "channel": "email",
        "message_text": "Вы среди 100 избранных для раннего доступа к продукту. Зарегистрируйтесь в течение 12 часов: [ссылка]. Оплата пока не нужна.",
        "tactic": "Scarcity",
        "choices_json": _choices(
            ("Зарегистрироваться по ссылке", False, "Дефицит: «один из 100» и срок подталкивают. Ссылка может собирать данные или вести к мошенникам.", 10),
            ("Поискать продукт и компанию и убедиться, что они существуют", True, "Верно. Проверка перед регистрацией безопасна.", -5),
            ("Игнорировать письмо", True, "Безопасно. Пропуск непрошеных предложений нормален.", -5),
            ("Переслать ссылку коллеге", False, "Пересылка непроверенных ссылок увеличивает риски для других.", 10),
        ),
    },
    {
        "title": "Звонок техподдержки",
        "channel": "call",
        "message_text": "Здравствуйте, звонят по поводу вируса, который мы обнаружили на вашем компьютере. Мы из поддержки [известная компания]. Можем удалённо всё исправить — зайдите на сайт и установите программу, которую мы пришлём.",
        "tactic": "Fear",
        "choices_json": _choices(
            ("Выполнить инструкции и установить программу", False, "Страх: ложные «вирусы» и удалённая установка — классика мошенничества под видом поддержки.", 10),
            ("Положить трубку и перезвонить компании по номеру с официального сайта", True, "Верно. Перезвон по проверенному номеру защищает от обмана.", -5),
            ("Отказаться и запустить свою антивирусную проверку", True, "Верно. Своё проверенное ПО безопаснее.", -5),
            ("Попросить номер заявки и перезвонить позже", True, "Разумно. Настоящая поддержка даст возможность проверить.", -5),
        ),
    },
]


async def seed_scenarios(db: AsyncSession) -> int:
    """Insert 12 scenarios if none exist. Returns number of scenarios now in DB."""
    result = await db.execute(select(func.count(Scenario.id)))
    count = int(result.scalar() or 0)

    if count > 0:
        return count

    for s in SCENARIOS:
        db.add(
            Scenario(
                title=s["title"],
                channel=s["channel"],
                message_text=s["message_text"],
                tactic=s["tactic"],
                choices_json=s["choices_json"],
            )
        )

    await db.commit()

    result2 = await db.execute(select(func.count(Scenario.id)))
    return int(result2.scalar() or 0)
